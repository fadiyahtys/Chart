<!DOCTYPE html>

<html>
 <head>
  <meta charset="UTF-8" />
  <title>OrgChart</title>
  <link rel="shortcut icon" type="image/x-icon" href="misc/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 </head>

 <body>
  <!----------------   ORG CHART NON ESSENTIAL CONTENT ------------>
  <script src="https://unpkg.com/html2canvas@1.1.4/dist/html2canvas.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <link
   href="https://cdn.jsdelivr.net/npm/simptip@1.0.4/simptip.min.css"
   rel="stylesheet"
  />

  <style>
   /* Reset body padding and margin */
   body {
     margin: 0;
     padding: 0;
     font-family: 'Inter', sans-serif;
   }

   /* Reset default margins */
   * {
     box-sizing: border-box;
   }

   [data-tooltip]:focus:after {
    display: none;
    border-bottom-color: none !important;
   }

   [data-tooltip]:focus:before {
    display: none;
    border-bottom-color: none !important;
   }

   [data-tooltip]:after {
    height: auto !important;
    padding: 11px 11px 11px 11px !important;
    content: attr(data-tooltip);
    white-space: pre;
    line-height: 16px !important;
    text-align: left !important;
   }

   /* Chart container styling */
   .chart-container {
     padding: 0 !important;
     margin: 0;
     background-color: #f8fafc !important;
   }

   /* Modern Navbar Styles */
   .action-buttons {
     margin: 0;
     background: #1d2b5e;
     padding: 0;
     box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
     position: sticky;
     top: 0;
     z-index: 1000;
     width: 100%;
     left: 0;
     right: 0;
   }

   .navbar {
     display: flex;
     justify-content: space-between;
     align-items: center;
     padding: 15px 20px;
     max-width: 100%;
   }

   .navbar-brand {
     color: white;
     font-size: 20px;
     font-weight: 600;
     text-decoration: none;
     display: flex;
     align-items: center;
     gap: 10px;
   }

   .navbar-brand img {
     height: 40px;
     width: auto;
     object-fit: contain;
   }

   .navbar-menu {
     display: flex;
     gap: 8px;
     align-items: center;
   }

   .navbar-divider {
     width: 1px;
     height: 30px;
     background: rgba(255, 255, 255, 0.3);
     margin: 0 15px;
   }

   .action-buttons button {
     background: rgba(255, 255, 255, 0.2);
     color: white;
     border: 1px solid rgba(255, 255, 255, 0.3);
     padding: 10px 16px;
     border-radius: 8px;
     font-size: 14px;
     font-weight: 500;
     cursor: pointer;
     transition: all 0.3s ease;
     white-space: nowrap;
     backdrop-filter: blur(10px);
   }

   .action-buttons button:hover {
     background: rgba(255, 255, 255, 0.3);
     border-color: rgba(255, 255, 255, 0.5);
     transform: translateY(-2px);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
   }

   .action-buttons button:active {
     transform: translateY(0);
   }

   /* Responsive */
   @media (max-width: 768px) {
     .navbar {
       flex-direction: column;
       gap: 15px;
       padding: 15px 20px;
     }
     
     .navbar-menu {
       flex-wrap: wrap;
       justify-content: center;
     }
     
     .navbar-divider {
       display: none;
     }
   }
  </style>

  <div class="action-buttons">
   <nav class="navbar">
     <div class="navbar-brand">
       <img src="./src/Logo.png" alt="Leighton Asia Logo" />
       Leighton Asia Organization Chart
     </div>
     
     <div class="navbar-menu">
       <!-- Layout Controls -->
       <button
        onclick='chart.layout(["right","bottom","left","top"][index++%4]).render().fit()'
        class="simptip-position-bottom"
        data-tooltip='chart.layout(["right","bottom","left","top"][index++%4]) &#xa; .render() &#xa; .fit()'
       >
        <i class="fas fa-exchange-alt"></i> Swap Layouts
       </button>
       <button
        onclick="chart.expandAll()"
        class="simptip-position-bottom"
        data-tooltip="chart.expandAll()"
       >
        <i class="fas fa-expand-arrows-alt"></i> Expand All
       </button>
       <button
        onclick="chart.collapseAll()"
        class="simptip-position-bottom"
        data-tooltip="chart.collapseAll()"
       >
        <i class="fas fa-compress-arrows-alt"></i> Collapse All
       </button>
       
       <div class="navbar-divider"></div>
       
       <!-- View Control -->
       <button
        onclick="chart.fullscreen()"
        class="simptip-position-bottom"
        data-tooltip="chart.fullscreen()"
       >
        <i class="fas fa-expand"></i> Full Screen
       </button>
     </div>
   </nav>
  </div>


  <!----------------  ORG CHART ESSENTIAL CONTENT ---------------->

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="./build/d3-org-chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.0.0/build/d3-flextree.js"></script>
  <div
   class="chart-container"
   style="padding-top: 10px; height: 1200px; background-color: white"
  ></div>

  <script>
   var index = 0;
   var chart;
   
   // Define colors for each department
   const departmentColors = {
    "President Director": "#2E86AB",
    "Senior Project Control Manager": "#A23B72", 
    "Commercial": "#F18F01",
    "Planning": "#C73E1D",
    "Procurement & Logistic": "#6A994E"
   };
   
   // Load data from Google Sheet - Multiple approaches
   const spreadsheetId = '2PACX-1vT_OCgq8RFU4ntnRUGq37oPZRwVSZ9hy1yUsU1mpND0Hljo91oL0G-HLi8-x1bMFZQ2pMUsK1yUpf7_';
   let dataFlattened = [];

   function loadGoogleSheetData() {
     // Method 1: Try direct CSV fetch with proper headers
     const csvUrl = `https://docs.google.com/spreadsheets/d/e/${spreadsheetId}/pub?output=csv`;
     
     fetch(csvUrl, {
       method: 'GET',
       mode: 'cors',
       cache: 'no-cache'
     })
     .then(response => {
       if (!response.ok) {
         throw new Error(`HTTP ${response.status}`);
       }
       return response.text();
     })
     .then(csvText => {
       if (!csvText || csvText.includes('<!DOCTYPE html>')) {
         throw new Error('Invalid CSV response');
       }
       
       const lines = csvText.split('\n').filter(line => line.trim());
       if (lines.length < 2) {
         throw new Error('No data found');
       }
       
       // Skip header row and parse data
       dataFlattened = lines.slice(1).map((line, index) => {
         const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
         return {
           id: values[0] || String(index + 100),
           parentId: values[1] || '',
           first_name: values[2] || '',
           last_name: values[3] || '',
           department_name: values[4] || '',
           img_url: values[5] || ''
         };
       });
       
       console.log('Successfully loaded', dataFlattened.length, 'records from Google Sheets');
       chart.data(dataFlattened).render();
     })
     .catch(error => {
       console.warn('Direct CSV fetch failed:', error.message);
       // Method 2: Try with a simple proxy
       tryAlternativeMethod();
     });
   }

   function tryAlternativeMethod() {
     // Method 2: Use a different approach - iframe or server-side
     console.log('Trying alternative method...');
     
     // For now, let's provide a manual data entry solution
     // You can copy-paste your CSV data here
     const csvData = `id,parentId,first_name,last_name,department_name,img_url
100,,Simon,Burley,President Director,
101,100,Zuraidah,Binti Mohd,Senior Project Control Manager,
102,173,Agus,Supramono,Commercial,
103,174,Ahnaf,Fairuz Ramadhan,Planning,
104,173,Boby,Hendrawan Harahap,Commercial,
105,175,Budi,Mulyanto,Procurement & Logistic,
106,175,Dedi,Prayitno,Procurement & Logistic,
107,174,Dimas,Sr Kuncoro,Planning,
108,173,Donny,Isyanto,Commercial,
109,173,Ellis,Trisnawati,Commercial,
110,174,Ferdinand,Ariesta,Planning,
111,174,Geoffrey,Timothy,Planning,
112,173,Indra,Gunawan,Commercial,
113,173,Jonathan,Julian,Commercial,
114,173,Josh,Kevin Limanta,Commercial,
115,173,Made,Dimas Agung Perwira,Commercial,
116,175,Tatang,Mawardi,Procurement & Logistic,
117,173,Wahju,Rachmat,Commercial,
118,174,Yazid,Ubaidilah,Planning,
119,175,Yohanes,Hermawan,Procurement & Logistic,
120,174,Yudha,Adrianto,Planning,
121,173,Yusaf,Tri Hartanto,Commercial,
122,175,Yusuf,Supriyanto,Procurement & Logistic,
123,105,Dinan,Mardiana,Procurement & Logistic,
124,105,Fadli,Fadli,Procurement & Logistic,
125,105,Fuad,Amirul Huda,Procurement & Logistic,
126,105,Harry,Setiyawan,Procurement & Logistic,
127,105,M.,Erry Bayurahardja,Procurement & Logistic,
128,105,Sidik,Kusuma Hendra,Procurement & Logistic,
129,105,Sukendar,Sukendar,Procurement & Logistic,
130,107,Eliana,Festica Tandilino',Planning,
131,107,Fajar,Restu Illahi,Planning,
132,108,Fany,Fil Addin,Commercial,
133,109,Ramzy,Farhan Zakaria,Commercial,
134,109,Riska,Sari Hardiyanti,Commercial,
135,109,Robi,Herwindo,Commercial,
136,110,Hana,Muzainah,Planning,
137,110,Rivaldo,Kamal,Planning,
138,112,Nurhana,Basri,Commercial,
139,113,Ade,Maya Kartini,Commercial,
140,113,Antonius,Manurung,Commercial,
141,113,Fadiyah,Nur Ayuning Tyas,Commercial,
142,113,Hanif,Fikri Maulana,Commercial,
143,113,Latifa,Lithasari Mutmainah,Commercial,
144,113,M.,Endrik Irwanto,Commercial,
145,113,Melani,Chandra Puspita,Commercial,
146,113,RA,Imareta Sulistiofanny,Commercial,
147,113,Rifqi,Ichwan Kurnia,Commercial,
148,113,Teguh,Sariyadi,Commercial,
149,115,Aang,Mochammad Iqbal,Commercial,
150,115,Dimas,Yuniandhika,Commercial,
151,115,Emanuel,Atyanto Widhi Nugroho,Commercial,
152,115,Muhammad,Rizky Elyano,Commercial,
153,115,Onivia,Nur Fitri Ardiani,Commercial,
154,117,Puspa,Zahra,Commercial,
155,120,Buing,Eko Prasetiyo,Planning,
156,120,Ishaq,Maulana Akbar,Planning,
157,140,Agus,Sriyanto,Commercial,
158,140,Aiman,Abdul Aziz,Commercial,
159,140,Arifa,Dwi Nabila,Commercial,
160,140,David,Permana,Commercial,
161,140,Karima,Nafilah,Commercial,
162,140,Muhammad,Agi Bahrul Faiz,Commercial,
163,140,Riki,Supriadi,Commercial,
164,140,Satrio,Wibowo,Commercial,
165,140,Tatok,Ariestiyantono,Commercial,
166,140,Yohanes,Surya,Commercial,
167,140,Yudha,Randa,Commercial,
168,140,Yulius,Hendra Kristanto,Commercial,
169,150,Ade,Rizki,Commercial,
170,150,Nur,Anisa Aprilyani,Commercial,
171,150,Tubagus,Cipta Perdana Harta,Commercial,
172,150,Wieke,Handjari,Commercial,
173,101,Commercial,Zuraidah Binti Mohd,Commercial,
174,101,Planning,TBA,Planning,
175,101,Procurement,Asep Indra,Procurement & Logistic`;

     const lines = csvData.split('\n').filter(line => line.trim());
     dataFlattened = lines.slice(1).map((line, index) => {
       const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
       return {
         id: values[0] || String(index + 100),
         parentId: values[1] || '',
         first_name: values[2] || '',
         last_name: values[3] || '',
         department_name: values[4] || '',
         img_url: values[5] || ''
       };
     });
     
     console.log('Using embedded data:', dataFlattened.length, 'records');
     chart.data(dataFlattened).render();
   }

    chart = new d3.OrgChart()
     .container(".chart-container")
     .pagingStep((d) => 5)
      .minPagingVisibleNodes((d) => 3)
     .data(dataFlattened)
     // .scaleExtent([1,1])
     // .svgHeight(window.innerHeight)
     // .nodeWidth((d3Node) => {
     //     return 200;
     //     let i = 0;
     //     if (d3Node.parent) { i = d3Node.parent.children.indexOf(d3Node); }
     //     if (i && i == d3Node.parent.children.length - 1) { return 600; }
     //     return (!i || i == d3Node.parent.children.length - 1) ? 300 : 100
     // })
     // .nodeHeight((d3Node) => {
     //     return 100;
     //     let i = 0;
     //     if (d3Node.parent) { i = d3Node.parent.children.indexOf(d3Node); }
     //     if (i && i == d3Node.parent.children.length - 1) { return 300; }
     //     return (!i || i == d3Node.parent.children.length - 1) ? 200 : 100
     // })
     // .siblingsMargin(d3Node => 0)
     // .childrenMargin(d3Node => 50)
     // .neighbourMargin((n1, n2) => 50)
     // .compactMarginPair(d3Node => 70)
     // .compactMarginBetween(d3Node => 30)
     // .setActiveNodeCentered(true)
     // .layout(new URLSearchParams(new URL(document.location.href).search).get('layout') || "top")
     // .onNodeClick(d => console.log(d + ' node clicked'))
     // .linkUpdate(function (d3Node, i, arr) {
     //     const link = this;
     //     d3.select(link)
     //         .attr('stroke-dasharray', !i ? '2 2' : 'none')
     //         .attr('stroke-width', 3)
     // })
     // .nodeUpdate(function (data, i, arr) {
     //     d3.select(this).on('click.node', (event, d, i) => {
     //         console.log(d.nodeId + ' node clicked')
     //     })
     // })
     // .connections(
     //     [
     //         { id: 1, from: "O-6067", to: "O-6068", label: "Directly Reports To" },
     //         { id: 2, from: "O-6070", to: "O-6066", label: "Reports To" },
     //         { id: 3, from: "O-6088", to: "O-6069", label: "They were coworkers once" },
     //         { id: 3, from: "O-6164", to: "O-6070", label: "Possible conflicts of interest" }
     //     ],
     // )
     .nodeContent(function (d, i, arr, state) {
        const deptColor = departmentColors[d.data.department_name] || "#718096";
        return `
           <div style="padding:0px;border:1px solid #E4E2E9;border-radius:8px;background-color:white;overflow:hidden;">
                <div style="background-color:${deptColor};padding:8px 10px;">
                    <div style="font-weight:bold;color:white;font-size:14px;">
                        ${d.data.first_name} ${d.data.last_name}
                    </div>
                </div>
                <div style="padding:10px;">
                    <div style="color:#716E7B;font-size:12px;">
                        ${d.data.department_name}
                    </div>
                    <div style="color:#999;font-size:10px;margin-top:4px;">
                        ID: ${d.data.id}
                    </div>
                </div>
           </div>
        `;
    })

     .nodeHeight((d) => 85 + 25)
     .nodeWidth((d) => {
      return 220 + 2;
     })
     .childrenMargin((d) => 50)
     .onNodeClick((d) => console.log("ok"))
     //  .layout('right')
     .compactMarginBetween((d) => 35)
     .compactMarginPair((d) => 30)
     .neighbourMargin((a, b) => 20);

    // .buttonContent(({ node, state }) => {
    //     return `<div style="color:#716E7B;border-radius:5px;padding:3px;font-size:10px;margin:auto auto;background-color:white;border: 1px solid #E4E2E9"> <span style="font-size:9px">${node.children ? `<i class="fas fa-angle-up"></i>` : `<i class="fas fa-angle-down"></i>`}</span> ${node.data._directSubordinates}  </div>`
    // })
    // .linkUpdate(function (d, i, arr) {
    //     d3.select(this)
    //         .attr("stroke", d => d.data._upToTheRootHighlighted ? '#152785' : '#E4E2E9')
    //         .attr("stroke-width", d => d.data._upToTheRootHighlighted ? 5 : 1)

    //     if (d.data._upToTheRootHighlighted) {
    //         d3.select(this).raise()
    //     }
    // })
    //  .nodeContent(function (d, i, arr, state) {
    //   const color = "#FFFFFF";
    //   const imageDiffVert = 25 + 2;
    //   return `
    //                 <div style='width:${
    //                  d.width
    //                 }px;height:${d.height}px;padding-top:${imageDiffVert - 2}px;padding-left:1px;padding-right:1px'>
    //                     <div style="font-family: 'Inter', sans-serif;background-color:${color};  margin-left:-1px;width:${d.width - 2}px;height:${d.height - imageDiffVert}px;border-radius:10px;border: 1px solid #E4E2E9">
    //                         <div style="display:flex;justify-content:flex-end;margin-top:5px;margin-right:5px">#${
    //                          d.data.id
    //                         }</div>
    //                         <div style="background-color:${color};margin-top:${-imageDiffVert - 20}px;margin-left:${15}px;border-radius:100px;width:50px;height:50px;" ></div>
    //                         <div style="margin-top:${
    //                          -imageDiffVert - 20
    //                         }px;">   <img src=" ${d.data.image}" style="margin-left:${20}px;border-radius:100px;width:40px;height:40px;" /></div>
    //                         <div style="font-size:15px;color:#08011E;margin-left:20px;margin-top:10px">  ${
    //                          d.data.name
    //                         } </div>
    //                         <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:10px;"> ${
    //                          d.data.position
    //                         } </div>

    //                     </div>
    //                 </div>
    //                         `;
    //  });

    chart.layoutBindings(
     (() => {
      const layouts = chart.layoutBindings();
      layouts.top.linkY = (node) => node.y + 0;
      layouts.top.linkCompactYStart = (node) => node.y + node.height / 2 + 15;
      return layouts;
     })()
    );

    chart.render();

    // Load data from Google Sheet when page loads
    loadGoogleSheetData();
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
   href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
   rel="stylesheet"
  />
  <link
   href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
   rel="stylesheet"
  />
  <style></style>
 </body>
</html>
